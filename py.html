window.uploadImages = async () => {
      if (!currentUser || selectedFiles.length === 0) return;

      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      progressDiv.style.display = 'block';
      uploadBtn.disabled = true;

      try {
        let completed = 0;
        const total = selectedFiles.length;

        for (const file of selectedFiles) {
          const timestamp = Date.now();
          const fileName = `${timestamp}_${file.name}`;
          const storageRef = ref(storage, `images/${currentUser.uid}/${fileName}`);
          
          const uploadTask = uploadBytesResumable(storageRef, file);

          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const fileProgress = (snapshot.bytesTransferred / snapshot.totalBytes);
                const totalProgress = ((completed + fileProgress) / total) * 100;
                progressBar.style.width = totalProgress + '%';
                progressText.textContent = Math.round(totalProgress) + '%';
              },
              (error) => {
                console.error('Error subiendo archivo:', error);
                alert('Error al subir: ' + error.message);
                reject(error);
              },
              async () => {
                completed++;
                console.log(`Archivo ${completed}/${total} subido exitosamente`);
                resolve();
              }
            );
          });
        }

        selectedFiles = [];
        preview.innerHTML = '';
        fileInput.value = '';
        uploadBtn.style.display = 'none';
        uploadBtn.disabled = false;
        progressDiv.style.display = 'none';
        progressBar.style.width = '0%';
        
        alert('¡Imágenes subidas exitosamente!');
        loadUserImages();
      } catch (error) {
        console.error('Error en uploadImages:', error);
        uploadBtn.disabled = false;
        progressDiv.style.display = 'none';
        alert('Error al subir imágenes. Verifica la consola para más detalles.');
      }
    };
