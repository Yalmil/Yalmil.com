<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sobrevive a las Letras</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      touch-action: none;
      background: #111;
      font-family: sans-serif;
      color: white;
    }
    canvas {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      display: block;
    }
    #joystickContainer {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      touch-action: none;
    }
    #joystickThumb {
      position: absolute;
      width: 60px;
      height: 60px;
      left: 30px;
      top: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      pointer-events: none;
    }
    #shootZone {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="joystickContainer">
    <div id="joystickThumb"></div>
  </div>
  <div id="shootZone"></div>
  <div id="hud">
    <div>Puntaje: <span id="score">0</span></div>
    <div>Récord: <span id="highScore">0</span></div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    let w = canvas.width = window.innerWidth;
    let h = canvas.height = window.innerHeight;

    let player = { x: w / 2, y: h / 2, size: 30, color: "cyan", speed: 3 };
    let bullets = [];
    let enemies = [];
    let lastSpawn = 0;
    let score = 0;
    let highScore = +localStorage.getItem("highScoreLetters") || 0;
    let shootDirection = { x: 0, y: 0 };

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

    // Joystick
    const joy = document.getElementById("joystickContainer");
    const thumb = document.getElementById("joystickThumb");
    let joyDir = { x: 0, y: 0 };
    let joyTouch = null;

    joy.addEventListener("touchstart", (e) => {
      joyTouch = e.targetTouches[0].identifier;
    });

    joy.addEventListener("touchmove", (e) => {
      for (let touch of e.changedTouches) {
        if (touch.identifier === joyTouch) {
          let rect = joy.getBoundingClientRect();
          let dx = touch.clientX - (rect.left + rect.width / 2);
          let dy = touch.clientY - (rect.top + rect.height / 2);
          let dist = Math.hypot(dx, dy);
          let maxDist = rect.width / 2;
          if (dist > maxDist) {
            dx *= maxDist / dist;
            dy *= maxDist / dist;
          }
          thumb.style.left = `${30 + dx}px`;
          thumb.style.top = `${30 + dy}px`;
          joyDir = { x: dx / maxDist, y: dy / maxDist };
        }
      }
    });

    joy.addEventListener("touchend", (e) => {
      for (let touch of e.changedTouches) {
        if (touch.identifier === joyTouch) {
          joyTouch = null;
          thumb.style.left = "30px";
          thumb.style.top = "30px";
          joyDir = { x: 0, y: 0 };
        }
      }
    });

    // Disparo táctil o mouse
    let isShooting = false;
    let shootInterval;

    function shoot() {
      if (shootDirection.x === 0 && shootDirection.y === 0) return;
      bullets.push({
        x: player.x,
        y: player.y,
        dx: shootDirection.x * 7,
        dy: shootDirection.y * 7,
        size: 6,
        color: "white"
      });
    }

    function startShooting() {
      if (!shootInterval) {
        shoot();
        shootInterval = setInterval(shoot, 200);
      }
    }

    function stopShooting() {
      clearInterval(shootInterval);
      shootInterval = null;
    }

    const shootZone = document.getElementById("shootZone");
    shootZone.addEventListener("touchstart", (e) => {
      isShooting = true;
      updateShootDirection(e.touches[0].clientX, e.touches[0].clientY);
      startShooting();
    });
    shootZone.addEventListener("touchmove", (e) => {
      updateShootDirection(e.touches[0].clientX, e.touches[0].clientY);
    });
    shootZone.addEventListener("touchend", () => {
      isShooting = false;
      stopShooting();
    });

    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      shootDirection = normalize(e.clientX - player.x, e.clientY - player.y);
    });

    canvas.addEventListener("mousedown", () => {
      startShooting();
    });

    canvas.addEventListener("mouseup", () => {
      stopShooting();
    });

    function normalize(x, y) {
      const len = Math.hypot(x, y);
      return len === 0 ? { x: 0, y: 0 } : { x: x / len, y: y / len };
    }

    function spawnEnemy() {
      const letter = letters[Math.floor(Math.random() * letters.length)];
      const side = Math.floor(Math.random() * 4);
      let x = 0, y = 0;
      if (side === 0) { x = Math.random() * w; y = -20; }
      if (side === 1) { x = w + 20; y = Math.random() * h; }
      if (side === 2) { x = Math.random() * w; y = h + 20; }
      if (side === 3) { x = -20; y = Math.random() * h; }

      const life = letters.indexOf(letter) + 1;
      enemies.push({ x, y, letter, size: 24, life, maxLife: life });
    }

    function update() {
      player.x += joyDir.x * player.speed;
      player.y += joyDir.y * player.speed;

      // Bordes
      player.x = Math.max(player.size / 2, Math.min(w - player.size / 2, player.x));
      player.y = Math.max(player.size / 2, Math.min(h - player.size / 2, player.y));

      bullets = bullets.filter(b => b.x > 0 && b.x < w && b.y > 0 && b.y < h);
      bullets.forEach(b => {
        b.x += b.dx;
        b.y += b.dy;
      });

      enemies.forEach(e => {
        const dir = normalize(player.x - e.x, player.y - e.y);
        e.x += dir.x * 1.2;
        e.y += dir.y * 1.2;
      });

      for (let i = enemies.length - 1; i >= 0; i--) {
        let e = enemies[i];
        for (let j = bullets.length - 1; j >= 0; j--) {
          let b = bullets[j];
          if (Math.hypot(e.x - b.x, e.y - b.y) < e.size) {
            e.life--;
            bullets.splice(j, 1);
            if (e.life <= 0) {
              score++;
              if (score > highScore) {
                highScore = score;
                localStorage.setItem("highScoreLetters", highScore);
              }
              enemies.splice(i, 1);
            }
            break;
          }
        }
      }

      if (Date.now() - lastSpawn > 1200) {
        spawnEnemy();
        lastSpawn = Date.now();
      }
    }

    function draw() {
      ctx.clearRect(0, 0, w, h);

      // Player
      ctx.fillStyle = player.color;
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.size / 2, 0, Math.PI * 2);
      ctx.fill();

      // Bullets
      bullets.forEach(b => {
        ctx.fillStyle = b.color;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.size, 0, Math.PI * 2);
        ctx.fill();
      });

      // Enemies
      enemies.forEach(e => {
        ctx.fillStyle = `hsl(${(letters.indexOf(e.letter) * 13) % 360}, 80%, 60%)`;
        ctx.beginPath();
        ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#000";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(e.letter, e.x, e.y);
      });

      document.getElementById("score").textContent = score;
      document.getElementById("highScore").textContent = highScore;
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    loop();

    window.addEventListener("resize", () => {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
    });
  </script>
</body>
</html>
