<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sala</title>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #141E30, #243B55);
      color: white;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
    }

    .container {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
    }

    h1 {
      margin-bottom: 20px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }

    li {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 10px;
      margin: 5px 0;
      font-weight: bold;
    }

    .organizador {
      color: #00e676;
    }

    #startBtn {
      display: none;
      background: #00c853;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    #startBtn:hover {
      background: #00e676;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="roomTitle">Sala</h1>
    <h3>Jugadores:</h3>
    <ul id="playersList"></ul>
    <button id="startBtn">Iniciar sala</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { 
      getDatabase, ref, onValue, get, set, remove, update, onDisconnect 
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZoRcoeC3MFMPYJWgl4dmNjq-U51dKD5o",
      authDomain: "databaseloginweb.firebaseapp.com",
      databaseURL: "https://databaseloginweb-default-rtdb.firebaseio.com",
      projectId: "databaseloginweb",
      storageBucket: "databaseloginweb.firebasestorage.app",
      messagingSenderId: "121538864529",
      appId: "1:121538864529:web:e92aaeaa4ba52618162630"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Datos locales
    const username = localStorage.getItem("username");
    const roomID = localStorage.getItem("roomID");
    let rol = localStorage.getItem("rol");

    const roomTitle = document.getElementById('roomTitle');
    const playersList = document.getElementById('playersList');
    const startBtn = document.getElementById('startBtn');

    if (!username || !roomID) {
      alert("No se encontró información de la sala. Regresando...");
      window.location.href = "https://yalmil.pages.dev";
    }

    // Mostrar ID de sala
    roomTitle.textContent = `Sala: ${roomID}`;

    // Mostrar botón solo al organizador
    if (rol === "Organizador") startBtn.style.display = "inline-block";

    const playerRef = ref(db, `salas/${roomID}/jugadores/${username}`);

    // ✅ Eliminar jugador automáticamente al desconectarse
    onDisconnect(playerRef).remove();

    // Escuchar en tiempo real los jugadores
    const roomRef = ref(db, `salas/${roomID}/jugadores`);
    onValue(roomRef, async (snapshot) => {
      playersList.innerHTML = "";

      if (snapshot.exists()) {
        const players = snapshot.val();
        const playerNames = Object.keys(players);

        // Mostrar lista de jugadores
        playerNames.forEach((name) => {
          const li = document.createElement("li");
          li.textContent = name;
          if (players[name].rol === "Organizador") {
            li.classList.add("organizador");
            li.textContent += " ⭐(Organizador)";
          }
          playersList.appendChild(li);
        });

        // ✅ Si el organizador se fue, reasignar a otro jugador aleatorio
        const organizadorPresente = playerNames.some(
          name => players[name].rol === "Organizador"
        );

        if (!organizadorPresente && playerNames.length > 0) {
          const randomPlayer = playerNames[Math.floor(Math.random() * playerNames.length)];
          await update(ref(db, `salas/${roomID}/jugadores/${randomPlayer}`), { rol: "Organizador" });
          console.log(`Nuevo organizador: ${randomPlayer}`);
        }

      } else {
        // ✅ Si ya no hay jugadores, eliminar toda la sala
        await remove(ref(db, `salas/${roomID}`));
        alert("La sala se cerró porque no hay jugadores activos");
        window.location.href = "https://yalmil.pages.dev";
      }
    });

    // Botón de iniciar sala
    startBtn.onclick = async () => {
      const roomData = await get(ref(db, `salas/${roomID}/jugadores`));
      if (!roomData.exists()) {
        alert("No hay jugadores en la sala");
        return;
      }

      const players = Object.keys(roomData.val());
      if (players.length < 2) {
        alert("Necesitas al menos 2 jugadores para iniciar");
        return;
      }

      alert("Sala iniciada. Redirigiendo...");
      // Aquí pondrás tu página final cuando la tengas
      // window.location.href = "https://yalmil.pages.dev/alp/iniciada.html";
    };

    // Si el usuario cierra la pestaña, limpiar localStorage
    window.addEventListener("beforeunload", () => {
      localStorage.removeItem("username");
      localStorage.removeItem("roomID");
      localStorage.removeItem("rol");
    });
  </script>
</body>
</html>
